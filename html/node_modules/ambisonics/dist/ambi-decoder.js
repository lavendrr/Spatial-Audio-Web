"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require("babel-runtime/helpers/createClass");

var _createClass3 = _interopRequireDefault(_createClass2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

////////////////////////////////////////////////////////////////////
//  Archontis Politis
//  archontis.politis@aalto.fi
//  David Poirier-Quinot
//  davipoir@ircam.fr
////////////////////////////////////////////////////////////////////
//
//  JSAmbisonics a JavaScript library for higher-order Ambisonics
//  The library implements Web Audio blocks that perform
//  typical ambisonic processing operations on audio signals.
//
////////////////////////////////////////////////////////////////////

///////////////////////////
/* HOA AMBISONIC DECODER */
///////////////////////////

var utils = require("./utils.js");

var decoder = function () {
    function decoder(audioCtx, order) {
        (0, _classCallCheck3.default)(this, decoder);


        // locals
        this.ctx = audioCtx;
        this.order = order;
        this.nCh = (order + 1) * (order + 1);
        this.nSpk = 0;
        this._decodingMatrix = [];
        this._spkSphPosArray = [];

        // Input and output nodes
        this.in = this.ctx.createChannelSplitter(this.nCh);
        this.out = this.ctx.createChannelMerger(1); // dummy

        // dummy init array
        this._spkSphPosArray = this._getDefaultSpkConfig(this.order);
        this._updateDecodeMtx(this._spkSphPosArray);
    }

    // spkSphPosArray in spherical coordinates: [ [azim1, elev1, dist1], ... [azimN, elevN, distN] ]


    (0, _createClass3.default)(decoder, [{
        key: "_updateDecodeMtx",


        // internal method to calculate Ambisonic decoding matrix and define new ambisonic gain nodes and values
        value: function _updateDecodeMtx(spkSphPosArray) {

            // update output
            this.nSpk = spkSphPosArray.length;
            this.out = this.ctx.createChannelMerger(this.nSpk);

            // get decoding matrix
            this._decodingMatrix = utils.getAmbisonicDecMtx(spkSphPosArray, this.order);

            // assign ambisonic gains to gain matrix + connect new graph
            this.mtxGain = new Array(this.nCh);
            for (var i = 0; i < this.nCh; i++) {
                this.mtxGain[i] = new Array(this.nSpk);
                for (var j = 0; j < this.nSpk; j++) {
                    // create / setup gain
                    var g = this.ctx.createGain();
                    g.gain.value = this._decodingMatrix[j][i];
                    // connect graph
                    this.in.connect(g, i, 0);
                    g.connect(this.out, 0, j);
                    // save to local
                    this.mtxGain[i][j] = g;
                }
            }
        }

        // get default speaker configuration for orders 1, 2, 3

    }, {
        key: "_getDefaultSpkConfig",
        value: function _getDefaultSpkConfig(order) {
            var spkSphPosArray = [];
            switch (order) {
                case 1:
                    // default first order: octahedron
                    spkSphPosArray = [[0, 0, 1], [90, 0, 1], [180, 0, 1], [270, 0, 1], [0, 90, 1], [0, -90, 1]];
                    break;
                case 2:
                    // default second order: icosahedron
                    spkSphPosArray = [[180.0000, -31.7161, 0.5878], [180.0000, 31.7161, 0.5878], [-121.7161, 0, 0.5878], [121.7161, 0, 0.5878], [-90.0000, -58.2839, 0.5878], [-90.0000, 58.2839, 0.5878], [90.0000, -58.2839, 0.5878], [90.0000, 58.2839, 0.5878], [-58.2839, 0, 0.5878], [58.2839, 0, 0.5878], [0, -31.7161, 0.5878], [0, 31.7161, 0.5878]];
                    break;
                case 3:
                    // default third order: dodecahedron
                    spkSphPosArray = [[-159.0931, 0, 0.5352], [159.0931, 0, 0.5352], [-135.0000, -35.2644, 0.5352], [-135.0000, 35.2644, 0.5352], [135.0000, -35.2644, 0.5352], [135.0000, 35.2644, 0.5352], [180.0000, -69.0931, 0.5352], [180.0000, 69.0931, 0.5352], [-90.0000, -20.9069, 0.5352], [-90.0000, 20.9069, 0.5352], [90.0000, -20.9069, 0.5352], [90.0000, 20.9069, 0.5352], [0, -69.0931, 0.5352], [0, 69.0931, 0.5352], [-45.0000, -35.2644, 0.5352], [-45.0000, 35.2644, 0.5352], [45.0000, -35.2644, 0.5352], [45.0000, 35.2644, 0.5352], [-20.9069, 0, 0.5352], [20.9069, 0, 0.5352]];
                    break;
                default:
                    console.error("unsupported default order:", order);
            }
            return spkSphPosArray;
        }
    }, {
        key: "speakerPos",
        set: function set(spkSphPosArray) {
            // set default array
            if (spkSphPosArray === undefined) {
                spkSphPosArray = this._getDefaultSpkConfig(this.order);
            }
            this._spkSphPosArray = spkSphPosArray;
            // discard old output
            this.out.disconnect();
            // update output / decode matrix 
            this._updateDecodeMtx(spkSphPosArray);
        },
        get: function get() {
            return this._spkSphPosArray;
        }
    }]);
    return decoder;
}();

exports.default = decoder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFtYmktZGVjb2Rlci5qcyJdLCJuYW1lcyI6WyJ1dGlscyIsInJlcXVpcmUiLCJkZWNvZGVyIiwiYXVkaW9DdHgiLCJvcmRlciIsImN0eCIsIm5DaCIsIm5TcGsiLCJfZGVjb2RpbmdNYXRyaXgiLCJfc3BrU3BoUG9zQXJyYXkiLCJpbiIsImNyZWF0ZUNoYW5uZWxTcGxpdHRlciIsIm91dCIsImNyZWF0ZUNoYW5uZWxNZXJnZXIiLCJfZ2V0RGVmYXVsdFNwa0NvbmZpZyIsIl91cGRhdGVEZWNvZGVNdHgiLCJzcGtTcGhQb3NBcnJheSIsImxlbmd0aCIsImdldEFtYmlzb25pY0RlY010eCIsIm10eEdhaW4iLCJBcnJheSIsImkiLCJqIiwiZyIsImNyZWF0ZUdhaW4iLCJnYWluIiwidmFsdWUiLCJjb25uZWN0IiwiY29uc29sZSIsImVycm9yIiwidW5kZWZpbmVkIiwiZGlzY29ubmVjdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUEsSUFBSUEsUUFBUUMsUUFBUSxZQUFSLENBQVo7O0lBRXFCQyxPO0FBRWpCLHFCQUFZQyxRQUFaLEVBQXNCQyxLQUF0QixFQUE2QjtBQUFBOzs7QUFFekI7QUFDQSxhQUFLQyxHQUFMLEdBQVdGLFFBQVg7QUFDQSxhQUFLQyxLQUFMLEdBQWFBLEtBQWI7QUFDQSxhQUFLRSxHQUFMLEdBQVcsQ0FBQ0YsUUFBUSxDQUFULEtBQWVBLFFBQVEsQ0FBdkIsQ0FBWDtBQUNBLGFBQUtHLElBQUwsR0FBWSxDQUFaO0FBQ0EsYUFBS0MsZUFBTCxHQUF1QixFQUF2QjtBQUNBLGFBQUtDLGVBQUwsR0FBdUIsRUFBdkI7O0FBRUE7QUFDQSxhQUFLQyxFQUFMLEdBQVUsS0FBS0wsR0FBTCxDQUFTTSxxQkFBVCxDQUErQixLQUFLTCxHQUFwQyxDQUFWO0FBQ0EsYUFBS00sR0FBTCxHQUFXLEtB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LE9BQWYsRUFBMkIsTUFBM0IsQ0FoQmEsRUFpQmIsQ0FBSSxPQUFKLEVBQWMsQ0FBQyxPQUFmLEVBQTJCLE1BQTNCLENBakJhLEVBa0JiLENBQUksT0FBSixFQUFlLE9BQWYsRUFBMkIsTUFBM0IsQ0FsQmEsRUFtQmIsQ0FBRyxDQUFDLE9BQUosRUFBcUIsQ0FBckIsRUFBMkIsTUFBM0IsQ0FuQmEsRUFvQmIsQ0FBSSxPQUFKLEVBQXFCLENBQXJCLEVBQTJCLE1BQTNCLENBcEJhLENBQWpCO0FBcUJBO0FBQ0o7QUFDSVksNEJBQVFDLEtBQVIsQ0FBYyw0QkFBZCxFQUE0Q3pCLEtBQTVDO0FBOUNSO0FBZ0RBLG1CQUFPWSxjQUFQO0FBQ0g7OzswQkEzRmNBLGMsRUFBZTtBQUMxQjtBQUNBLGdCQUFJQSxtQkFBbUJjLFNBQXZCLEVBQWtDO0FBQUVkLGlDQUFpQixLQUFLRixvQkFBTCxDQUEwQixLQUFLVixLQUEvQixDQUFqQjtBQUF5RDtBQUM3RixpQkFBS0ssZUFBTCxHQUF1Qk8sY0FBdkI7QUFDQTtBQUNBLGlCQUFLSixHQUFMLENBQVNtQixVQUFUO0FBQ0E7QUFDQSxpQkFBS2hCLGdCQUFMLENBQXVCQyxjQUF2QjtBQUNILFM7NEJBRWU7QUFBRSxtQkFBTyxLQUFLUCxlQUFaO0FBQThCOzs7OztrQkFoQy9CUCxPIiwiZmlsZSI6ImFtYmktZGVjb2Rlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyAgQXJjaG9udGlzIFBvbGl0aXNcbi8vICBhcmNob250aXMucG9saXRpc0BhYWx0by5maVxuLy8gIERhdmlkIFBvaXJpZXItUXVpbm90XG4vLyAgZGF2aXBvaXJAaXJjYW0uZnJcbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vL1xuLy8gIEpTQW1iaXNvbmljcyBhIEphdmFTY3JpcHQgbGlicmFyeSBmb3IgaGlnaGVyLW9yZGVyIEFtYmlzb25pY3Ncbi8vICBUaGUgbGlicmFyeSBpbXBsZW1lbnRzIFdlYiBBdWRpbyBibG9ja3MgdGhhdCBwZXJmb3JtXG4vLyAgdHlwaWNhbCBhbWJpc29uaWMgcHJvY2Vzc2luZyBvcGVyYXRpb25zIG9uIGF1ZGlvIHNpZ25hbHMuXG4vL1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vKiBIT0EgQU1CSVNPTklDIERFQ09ERVIgKi9cbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG52YXIgdXRpbHMgPSByZXF1aXJlKFwiLi91dGlscy5qc1wiKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgZGVjb2RlciB7XG5cbiAgICBjb25zdHJ1Y3RvcihhdWRpb0N0eCwgb3JkZXIpIHtcblxuICAgICAgICAvLyBsb2NhbHNcbiAgICAgICAgdGhpcy5jdHggPSBhdWRpb0N0eDtcbiAgICAgICAgdGhpcy5vcmRlciA9IG9yZGVyO1xuICAgICAgICB0aGlzLm5DaCA9IChvcmRlciArIDEpICogKG9yZGVyICsgMSk7XG4gICAgICAgIHRoaXMublNwayA9IDA7XG4gICAgICAgIHRoaXMuX2RlY29kaW5nTWF0cml4ID0gW107XG4gICAgICAgIHRoaXMuX3Nwa1NwaFBvc0FycmF5ID0gW107XG5cbiAgICAgICAgLy8gSW5wdXQgYW5kIG91dHB1dCBub2Rlc1xuICAgICAgICB0aGlzLmluID0gdGhpcy5jdHguY3JlYXRlQ2hhbm5lbFNwbGl0dGVyKHRoaXMubkNoKTtcbiAgICAgICAgdGhpcy5vdXQgPSB0aGlzLmN0eC5jcmVhdGVDaGFubmVsTWVyZ2VyKDEpOyAvLyBkdW1teVxuXG4gICAgICAgIC8vIGR1bW15IGluaXQgYXJyYXlcbiAgICAgICAgdGhpcy5fc3BrU3BoUG9zQXJyYXkgPSB0aGlzLl9nZXREZWZhdWx0U3BrQ29uZmlnKHRoaXMub3JkZXIpO1xuICAgICAgICB0aGlzLl91cGRhdGVEZWNvZGVNdHgoIHRoaXMuX3Nwa1NwaFBvc0FycmF5ICk7XG4gICAgfVxuXG4gICAgLy8gc3BrU3BoUG9zQXJyYXkgaW4gc3BoZXJpY2FsIGNvb3JkaW5hdGVzOiBbIFthemltMSwgZWxldjEsIGRpc3QxXSwgLi4uIFthemltTiwgZWxldk4sIGRpc3ROXSBdXG4gICAgc2V0IHNwZWFrZXJQb3Moc3BrU3BoUG9zQXJyYXkpe1xuICAgICAgICAvLyBzZXQgZGVmYXVsdCBhcnJheVxuICAgICAgICBpZiggc3BrU3BoUG9zQXJyYXkgPT09IHVuZGVmaW5lZCApeyBzcGtTcGhQb3NBcnJheSA9IHRoaXMuX2dldERlZmF1bHRTcGtDb25maWcodGhpcy5vcmRlcik7IH1cbiAgICAgICAgdGhpcy5fc3BrU3BoUG9zQXJyYXkgPSBzcGtTcGhQb3NBcnJheTtcbiAgICAgICAgLy8gZGlzY2FyZCBvbGQgb3V0cHV0XG4gICAgICAgIHRoaXMub3V0LmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgLy8gdXBkYXRlIG91dHB1dCAvIGRlY29kZSBtYXRyaXggXG4gICAgICAgIHRoaXMuX3VwZGF0ZURlY29kZU10eCggc3BrU3BoUG9zQXJyYXkgKTtcbiAgICB9XG5cbiAgICBnZXQgc3BlYWtlclBvcygpeyByZXR1cm4gdGhpcy5fc3BrU3BoUG9zQXJyYXk7IH1cblxuICAgIC8vIGludGVybmFsIG1ldGhvZCB0byBjYWxjdWxhdGUgQW1iaXNvbmljIGRlY29kaW5nIG1hdHJpeCBhbmQgZGVmaW5lIG5ldyBhbWJpc29uaWMgZ2FpbiBub2RlcyBhbmQgdmFsdWVzXG4gICAgX3VwZGF0ZURlY29kZU10eChzcGtTcGhQb3NBcnJheSl7XG4gICAgICAgIFxuICAgICAgICAvLyB1cGRhdGUgb3V0cHV0XG4gICAgICAgIHRoaXMublNwayA9IHNwa1NwaFBvc0FycmF5Lmxlbmd0aDtcbiAgICAgICAgdGhpcy5vdXQgPSB0aGlzLmN0eC5jcmVhdGVDaGFubmVsTWVyZ2VyKHRoaXMublNwayk7XG5cbiAgICAgICAgLy8gZ2V0IGRlY29kaW5nIG1hdHJpeFxuICAgICAgICB0aGlzLl9kZWNvZGluZ01hdHJpeCA9IHV0aWxzLmdldEFtYmlzb25pY0RlY010eChzcGtTcGhQb3NBcnJheSwgdGhpcy5vcmRlcik7XG5cbiAgICAgICAgLy8gYXNzaWduIGFtYmlzb25pYyBnYWlucyB0byBnYWluIG1hdHJpeCArIGNvbm5lY3QgbmV3IGdyYXBoXG4gICAgICAgIHRoaXMubXR4R2FpbiA9IG5ldyBBcnJheSh0aGlzLm5DaCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5uQ2g7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5tdHhHYWluW2ldID0gbmV3IEFycmF5KHRoaXMublNwayk7XG4gICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRoaXMublNwazsgaisrKSB7XG4gICAgICAgICAgICAgICAgLy8gY3JlYXRlIC8gc2V0dXAgZ2FpblxuICAgICAgICAgICAgICAgIGxldCBnID0gdGhpcy5jdHguY3JlYXRlR2FpbigpO1xuICAgICAgICAgICAgICAgIGcuZ2Fpbi52YWx1ZSA9IHRoaXMuX2RlY29kaW5nTWF0cml4W2pdW2ldO1xuICAgICAgICAgICAgICAgIC8vIGNvbm5lY3QgZ3JhcGhcbiAgICAgICAgICAgICAgICB0aGlzLmluLmNvbm5lY3QoZywgaSwgMCk7XG4gICAgICAgICAgICAgICAgZy5jb25uZWN0KHRoaXMub3V0LCAwLCBqKTtcbiAgICAgICAgICAgICAgICAvLyBzYXZlIHRvIGxvY2FsXG4gICAgICAgICAgICAgICAgdGhpcy5tdHhHYWluW2ldW2pdID0gZztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIGdldCBkZWZhdWx0IHNwZWFrZXIgY29uZmlndXJhdGlvbiBmb3Igb3JkZXJzIDEsIDIsIDNcbiAgICBfZ2V0RGVmYXVsdFNwa0NvbmZpZyhvcmRlcil7XG4gICAgICAgIGxldCBzcGtTcGhQb3NBcnJheSA9IFtdO1xuICAgICAgICBzd2l0Y2gob3JkZXIpIHtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICAvLyBkZWZhdWx0IGZpcnN0IG9yZGVyOiBvY3RhaGVkcm9uXG4gICAgICAgICAgICAgICAgc3BrU3BoUG9zQXJyYXkgPSBbIFswLCAwLCAxXSwgWzkwLCAwLCAxXSwgWzE4MCwgMCwgMV0sIFsyNzAsIDAsIDFdLCBbMCwgOTAsIDFdLCBbMCwgLTkwLCAxXSBdO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgICAgIC8vIGRlZmF1bHQgc2Vjb25kIG9yZGVyOiBpY29zYWhlZHJvblxuICAgICAgICAgICAgICAgIHNwa1NwaFBvc0FycmF5ID0gW1xuICAgICAgICAgICAgICAgICAgICBbICAxODAuMDAwMCwgIC0zMS43MTYxLCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAxODAuMDAwMCwgICAzMS43MTYxLCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbIC0xMjEuNzE2MSwgICAgICAgICAwLCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAxMjEuNzE2MSwgICAgICAgICAwLCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAtOTAuMDAwMCwgIC01OC4yODM5LCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAtOTAuMDAwMCwgICA1OC4yODM5LCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAgOTAuMDAwMCwgIC01OC4yODM5LCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAgOTAuMDAwMCwgICA1OC4yODM5LCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAtNTguMjgzOSwgICAgICAgICAwLCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAgNTguMjgzOSwgICAgICAgICAwLCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAgICAgICAgMCwgIC0zMS43MTYxLCAgICAwLjU4NzhdLFxuICAgICAgICAgICAgICAgICAgICBbICAgICAgICAgMCwgICAzMS43MTYxLCAgICAwLjU4NzhdXTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgMzpcbiAgICAgICAgICAgICAgICAvLyBkZWZhdWx0IHRoaXJkIG9yZGVyOiBkb2RlY2FoZWRyb25cbiAgICAgICAgICAgICAgICBzcGtTcGhQb3NBcnJheSA9IFtcbiAgICAgICAgICAgICAgICAgICAgWyAtMTU5LjA5MzEsICAgICAgICAgMCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgMTU5LjA5MzEsICAgICAgICAgMCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAtMTM1LjAwMDAsICAtMzUuMjY0NCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAtMTM1LjAwMDAsICAgMzUuMjY0NCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgMTM1LjAwMDAsICAtMzUuMjY0NCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgMTM1LjAwMDAsICAgMzUuMjY0NCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgMTgwLjAwMDAsICAtNjkuMDkzMSwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgMTgwLjAwMDAsICAgNjkuMDkzMSwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgLTkwLjAwMDAsICAtMjAuOTA2OSwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgLTkwLjAwMDAsICAgMjAuOTA2OSwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgIDkwLjAwMDAsICAtMjAuOTA2OSwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgIDkwLjAwMDAsICAgMjAuOTA2OSwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgICAgICAgIDAsICAtNjkuMDkzMSwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgICAgICAgIDAsICAgNjkuMDkzMSwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgLTQ1LjAwMDAsICAtMzUuMjY0NCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgLTQ1LjAwMDAsICAgMzUuMjY0NCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgIDQ1LjAwMDAsICAtMzUuMjY0NCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgIDQ1LjAwMDAsICAgMzUuMjY0NCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgLTIwLjkwNjksICAgICAgICAgMCwgICAgMC41MzUyXSxcbiAgICAgICAgICAgICAgICAgICAgWyAgIDIwLjkwNjksICAgICAgICAgMCwgICAgMC41MzUyXV07XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJ1bnN1cHBvcnRlZCBkZWZhdWx0IG9yZGVyOlwiLCBvcmRlcik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNwa1NwaFBvc0FycmF5XG4gICAgfVxufVxuIl19